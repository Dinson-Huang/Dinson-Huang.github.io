<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="Android,设计模式,安卓入门,安卓高级,前端,JavaScript,h5,css3,Jquery">
  <meta name="description" content="null">
  <meta name="author" content="DINSON">
 
 
<meta name="keywords" content="FontMetrics ImageSpan,Android,设计模式,安卓入门,安卓高级,前端,JavaScript,h5,css3,Jquery">


  
  <title>FontMetrics以及自定义ImageSpan实现TextView图文混排时文图的居中对齐</title>
  

  <link rel="alternate" href="/atom.xml" title="Android - Dinson - 酸奶布丁 - 国家一级码农" type="application/atom+xml">
  <link rel="canonical" href="http://dinson.win/2017/06/10/17-06-10/index.html">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_8ce77jkwodt5ipb9.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-home"></i><a href="/index.html" class="aside-menu-link" title="酸奶布丁">酸奶布丁</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-all"></i><a href="/archives/index.html" class="aside-menu-link" title="时间印记">时间印记</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-tag"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标记">分类标记</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-python"></i><a href="http://dinson.win/Python/index.html" class="aside-menu-link" title="Python">Python</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-jinglingqiu"></i><a href="http://dinson.win/Pokemon/" class="aside-menu-link" title="口袋妖怪">口袋妖怪</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-me"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-rss"></i><a href="/atom.xml" class="aside-menu-link" title="RSS">RSS</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-quxiao"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.jpg" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          Dinson
          
          <strong class="aside-avatar-STRONG">Android喵</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">面朝电脑--栀子花开</p>
      <ul class="aside-show-info" >
	  <li class="aside-show-item"><a href="https://github.com/DinsonCat" class="aside-show-link" target="_blank"><i class="aside-show-icon iconfont icon-github"></i></a></li>
        <li class="aside-show-item">
          <a href="javascript: void(0);" class="aside-show-link"   target="_blank"><i class="aside-show-icon iconfont icon-wechat"></i></a>
          <div class="aside-show-outside aside-show-outside_1">
            <img class="aside-show-IMG aside-show-IMG_1" src="/img/weixin.png" alt="微信"  >
          </div>
        </li>
        <li class="aside-show-item">
          <a href="javascript: void(0);" class="aside-show-link"   target="_blank"><i class="aside-show-icon iconfont icon-qq"></i></a>
          <div class="aside-show-outside">
            <img class="aside-show-IMG  " src="/img/qq.jpg"   alt="QQ">
          </div>
        </li>
		 
      </ul>
	
	 
    </div>
	
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">FontMetrics以及自定义ImageSpan实现TextView图文混排时文图的居中对齐</h1>
    <p class="post-meta">
      </span>
      
      <a href="/categories/Android嫡系/" class="post-categories">Android嫡系</a>
      
      
      <a href="/tags/ImageSpan/"" class="post-tags"><i class="post-tags-icon iconfont icon-waixingren"></i>ImageSpan</a>
      
	  
	  
		<span id="busuanzi_container_page_pv"  class="post-time"><i class="post-tags-icon iconfont icon-yuedu"></i>Views <span id="busuanzi_value_page_pv"></span> Times</span>
	  
	  
    </p>
    
  </header>
  <div class="post-content"><p><img src="http://ondlsj2sn.bkt.clouddn.com/FqRj0Yf7Vco8-6vAOnkTT1NSWyJp.png" alt=""></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><blockquote>
<p>在上图中整体实现的时候使用的是popUpWindow。该popupWindow整体使用相对布局，里面再用一个相对布局布局嵌套了三个TextView：”啊哦。。。。pass” 用一个TextView，中间灰色的上传头像的提示用了一个TextView，底部“我知道了” 也是一个TextView。上面的左划示意图使用above 放在 包含TextView的相对布局上方，并通过负的margin值将它下移并覆盖在包含TextView相对布局上。</p>
</blockquote>
<p>这个界面并没有什么难度，这里重点说的是第一个TextView中的图文混排，并让图片的横向中间线与该行文字的横向中间线对齐，也就是说，让文字与那个💔 图片的中间在水平方向对齐。</p>
<a id="more"></a>
<!-- 这是　　缩进-->
<h2 id="图文混排的方式有哪些？"><a href="#图文混排的方式有哪些？" class="headerlink" title="图文混排的方式有哪些？"></a>图文混排的方式有哪些？</h2><p>通常我们向TextView中插入图片实现图文混排有如下方式：</p>
<ol>
<li>使用drawableLeft等属性设置，这种方式对应的java方法是 setCompoundDrawablesWithIntrinsicBounds(leftDrawble,topDrawable,rightDrawable,bottomDrawable);</li>
<li>使用 SpannableString ,先将图片转成ImageSpan对象，然后通过setSpan插入到SpannableString 中，最后再将SpannableString通过setText设置给TextView。（SpannableString 继承自CharSquence）</li>
<li>此外，还有一种利用Html.ImageGetter格式化图片的方式。（截止目前为止，我没用过这种方式，如果想了解的话，可以参考<a href="http://wangleyiang.iteye.com/blog/1771439中的第二点）" target="_blank" rel="external">http://wangleyiang.iteye.com/blog/1771439中的第二点）</a></li>
</ol>
<h2 id="使用SpannableString-ImageSpan怎么实现图文混排？"><a href="#使用SpannableString-ImageSpan怎么实现图文混排？" class="headerlink" title="使用SpannableString+ImageSpan怎么实现图文混排？"></a>使用SpannableString+ImageSpan怎么实现图文混排？</h2><p>(1). 基本实现方式<br>效果图如下：<br><img src="http://ondlsj2sn.bkt.clouddn.com/FkIGaIysmg-9PW07xdUttjrP4k4t.png" alt=""><br>实现方式很简单，我们只需要在xml布局文件中定义一个TextView，然后在代码中获取该TextView并创建一个含有图片的SpannableString,并将该SpannableString通过setText( )设置给TextView即可。代码如下：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SpannableStringAndImageSpanActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> void onCreate(<span class="type">Bundle</span> savedInstanceState) &#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(<span class="type">R</span>.layout.activity_spannbalestring_imagespan);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> void init() &#123;</div><div class="line"></div><div class="line">        <span class="type">TextView</span> tv_test = (<span class="type">TextView</span>) findViewById(<span class="type">R</span>.id.tv_test);</div><div class="line">        <span class="type">SpannableString</span> spannableString = <span class="keyword">new</span> <span class="type">SpannableString</span>(<span class="string">"点击 按钮有惊喜"</span>);</div><div class="line"></div><div class="line">        <span class="type">ImageSpan</span> imageSpan = <span class="keyword">new</span> <span class="type">ImageSpan</span>(<span class="keyword">this</span>, <span class="type">R</span>.mipmap.ic_launcher);</div><div class="line"></div><div class="line">        <span class="comment">//setSpan插入内容的时候，起始位置不替换，会替换起始位置到终止位置间的内容，含终止位置。</span></div><div class="line">        <span class="comment">//Spanned.SPAN_EXCLUSIVE_EXCLUSIVE模式用来控制是否同步设置新插入的内容与start/end 位置的字体样式，此处没设置具体字体，所以可以随意设置</span></div><div class="line">        spannableString.setSpan(imageSpan, <span class="number">2</span>, <span class="number">3</span>, <span class="type">Spanned</span>.<span class="type">SPAN_INCLUSIVE_EXCLUSIVE</span>);</div><div class="line">        tv_test.setText(spannableString);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>xml布局文件中只给了一个普通的TextView，代码省略。</p>
<blockquote>
<ol>
<li><p>在上面的代码中，我们通过ImageSpan的构造方法得到了一个ImageSpan对象。该构造方法中传入的两个参数分别是上下文和图片的id。（imageSpan的构造方法还有很多）</p>
</li>
<li><p>SpannbaleString的setSpan方法中，传入的四个参数分别是 ImageSpan对象、将ImageSpan插入到的起始位置(start)、将ImageSpan插入到的终点位置(end)、是否应用字体样式。具体将ImageSpan对象插入到哪个位置，由第二个和第三个参数确定，插入的时候会覆盖从 start 位置开始（不包含该位置）到终止位置间的内容（包含该位置）。第四个参数是在你插入文本的时候使用的，用来控制新插入的文本与已有文本内容的字体样式是否一致的如果你插入的是图片，这里就可以随便选择一种模式。</p>
</li>
</ol>
</blockquote>
<p>经过上面虽然实现了图文混排，但是，细心的你可能发现了，这时候的文字和图片是基于底部对齐的（由于图片的原因，图片底部与边框有一点点的间距）。那么如果我想更改对齐方式怎么办呢？</p>
<p>(2). 更改图片与文本的对齐方式–ALIGN_BASELINE对齐</p>
<p>设置对齐方式的方法很简单，在构造ImageSpan对象的时候，传入第三个参数ALIGN_BASELINE 即可，代码如下：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ImageSpan imageSpan = <span class="keyword">new</span> <span class="type">ImageSpan</span>(<span class="built_in">this</span>, R.mipmap.ic_launcher, DynamicDrawableSpan.ALIGN_BASELINE);</div></pre></td></tr></table></figure></p>
<p>设置对齐方式为ALIGN_BASELINE后的效果图：<br><img src="http://ondlsj2sn.bkt.clouddn.com/Fi_w7QCAL-zoRiNVTE2d8zHqgeJV.png" alt=""><br>咦，看着跟上面的图没啥区别啊？那么我再把上面没设置对齐方式的图拉下来看下：<br><img src="http://ondlsj2sn.bkt.clouddn.com/FkIGaIysmg-9PW07xdUttjrP4k4t.png" alt=""><br>仔细对比下，我们发现，设置对齐方式之后，图往上跑了一点点。</p>
<blockquote>
<p><strong>其实，在ImageSpan 中，官方只给出了两中对齐方式：</strong></p>
<ol>
<li>一种是 ALIGN_BOTTOM , 表示与文字内容的底部对齐，如果在构造ImageSpan时没有传入对齐方式，那么默认就是这种底部对齐。</li>
<li>另一中就是 ALIGN_BASELINE, 表示与文字内容的基线对齐。那么，你可能会问我基线是啥？请继续往下看：</li>
</ol>
</blockquote>
<h2 id="Paint-FontMetrics-是啥？"><a href="#Paint-FontMetrics-是啥？" class="headerlink" title="Paint.FontMetrics 是啥？"></a>Paint.FontMetrics 是啥？</h2><p>(1). Paint.FontMetrics基本介绍<br>要说基线呢，我们先了解这个Paint.FontMetircs, 官方对该类的解释是：<code>Class that describes the various metrics for a font at a given text size.</code>, 意思是说，这玩意儿是绘制文本内容时存储该文本内容位置信息的一个类。这个类中有如下五个字段：<br><img src="http://ondlsj2sn.bkt.clouddn.com/Fv3daCrXBC7dgBY8PHz0xL3gKbWL.png" alt=""></p>
<p>(2). BaseLine 基线到底是啥？<br>上图中这5个字段除了leading 外，其他四个都是相对于 基线BaseLine来确定的，那么，到底啥是基线？？先来看一张图：<br><img src="http://ondlsj2sn.bkt.clouddn.com/Fm1DOwbK_ENlyHRHqkMVT0gv40k-.png" alt=""><br>如上图，<strong>标准的英文书写是基于四线三格，其中，我们书写英文的时候，都是以第三条线为基准，也就是说，基线就是这个四线三格中的第三条线！！</strong></p>
<p>(3). Paint.FontMetrics中字段的含义及示意图<br>官方文档中对这几个字段的解释很简单，但理解起来挺费劲，直接上图，<strong>图中的标注都是跑代码之后确定的，如果有不准确的地方，欢迎指正：</strong><br><img src="http://ondlsj2sn.bkt.clouddn.com/FngzbBPGHMEfeySioy3dzCoV19em.png" alt=""><br>根据上图可知：</p>
<ul>
<li><p>ascent<br>文字内容的顶部到基线的距离。即 ascent=文字内容顶部Y坐标 - 基线Y坐标。由于android中坐标系是 右下为正，所以得到的ascent实际是一个负数。 </p>
</li>
<li><p>descent<br>文字内容的底部到基线的距离。即 descent=文字内容底部Y坐标 - 基线Y坐标。</p>
</li>
<li><p>基线<br>在图中，基线的坐标用Y表示，在ImageSpan父类的 draw( ) 中，会传入一个 float Y ,就是这个基线的坐标。实际上，基线的Y坐标=文字内容中间线Y坐标+1/2 （文字内容高度）</p>
</li>
<li><p>top<br>对应图中 文字所在行的top 坐标</p>
</li>
<li><p>bottom<br>对应图中 文字所在行的bottom 坐标<br>需要注意：如果设置了行间距，且文本内容产生了换行，那么这个bottom 也会将行间距包裹。所以， 图中蓝色的文字内容中间线的Y轴坐标并不一定等于 (bottom+top)/2</p>
</li>
</ul>
<h2 id="自定义ImageSpan实现文字与图片居中对齐"><a href="#自定义ImageSpan实现文字与图片居中对齐" class="headerlink" title="自定义ImageSpan实现文字与图片居中对齐"></a>自定义ImageSpan实现文字与图片居中对齐</h2><p>好了，前面说了那么多，终于进入正题了。。。<br>在上面的2 SpannableString+ImageSpan实现图文混排中，我们已经知道官方并没有给出文字与图片居中对齐的模式,所以需要我们自定义。</p>
<p>关于自定义ImageSpan的分析，此处不再赘述，请参考<a href="http://dinson.win/2017/06/08/17-06-08/">http://dinson.win/2017/06/08/17-06-08/</a>。但是，按照该文章中的代码实现的时候，有个问题就是：如果给TextView设置了行间距，且文本产生了换行，那么就无法对齐了！！</p>
<p>那么，设置了行间距之后，该如何实现文本和图片的居中对齐呢？请看：<a href="http://dinson.win/2017/06/09/17-06-09/">http://dinson.win/2017/06/09/17-06-09/</a>, 但是，这篇文章中的实现方式没有重写 getSize( ) 方法，所以也有一个问题：文本和图片并不是在TextView的居中位置，而且如果图片高于文本的话，图片会显示不全！！如下图：<br><img src="http://ondlsj2sn.bkt.clouddn.com/FhKYKIaBNh4DkMbY0kENHb7aQ2vL.png" alt=""></p>
<h2 id="终极方案"><a href="#终极方案" class="headerlink" title="终极方案"></a>终极方案</h2><p>其实我们自定义的时候，需要做的事情是 获取文本内容的中间线以及图片的中间线，然后获取两者差值，然后在draw方法中绘制图片时将差值作为canvas.translate(x, transY) 中的transY；同时要重写 getSize( )。这样最终实现的效果是，不论是否设置行间距，不论图片大于文本还是文本大于图片，都能实现文本和图片的居中对齐！</p>
<p>看最终效果图：<br><img src="http://ondlsj2sn.bkt.clouddn.com/FgZ8DSaHUmakjUgG-EKhKTDfYlY0.png" alt=""><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpannableStringAndImageSpanActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_spannbalestring_imagespan);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        TextView tv_test = (TextView) findViewById(R.id.tv_test);</div><div class="line">        SpannableString spannableString = <span class="keyword">new</span> SpannableString(<span class="string">"点击 按钮有惊喜"</span>);</div><div class="line"></div><div class="line">        <span class="comment">//调用自定义的imageSpan,实现文字与图片的横向居中对齐</span></div><div class="line">        CustomImageSpan imageSpan = <span class="keyword">new</span> CustomImageSpan(<span class="keyword">this</span>, R.mipmap.ic_launcher, <span class="number">2</span>);</div><div class="line"></div><div class="line">        <span class="comment">//setSpan插入内容的时候，起始位置不替换，会替换起始位置到终止位置间的内容，含终止位置。</span></div><div class="line">        <span class="comment">//Spanned.SPAN_EXCLUSIVE_EXCLUSIVE模式用来控制是否同步设置新插入的内容与start/end 位置的字体样式，此处没设置具体字体，所以可以随意设置</span></div><div class="line">        spannableString.setSpan(imageSpan, <span class="number">2</span>, <span class="number">3</span>, Spanned.SPAN_INCLUSIVE_EXCLUSIVE);</div><div class="line">        tv_test.setText(spannableString);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 自定义imageSpan实现图片与文字的居中对齐</div><div class="line">     */</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">CustomImageSpan</span> <span class="keyword">extends</span> <span class="title">ImageSpan</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//自定义对齐方式--与文字中间线对齐</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> ALIGN_FONTCENTER = <span class="number">2</span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomImageSpan</span><span class="params">(Context context, <span class="keyword">int</span> resourceId)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(context, resourceId);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomImageSpan</span><span class="params">(Context context, <span class="keyword">int</span> resourceId, <span class="keyword">int</span> verticalAlignment)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(context, resourceId, verticalAlignment);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas, CharSequence text, <span class="keyword">int</span> start, <span class="keyword">int</span> end, <span class="keyword">float</span> x, <span class="keyword">int</span> top, <span class="keyword">int</span> y, <span class="keyword">int</span> bottom,</span></span></div><div class="line">                         Paint paint) &#123;</div><div class="line"></div><div class="line">            <span class="comment">//draw 方法是重写的ImageSpan父类 DynamicDrawableSpan中的方法，在DynamicDrawableSpan类中，虽有getCachedDrawable()，</span></div><div class="line">            <span class="comment">// 但是私有的，不能被调用，所以调用ImageSpan中的getrawable()方法，该方法中 会根据传入的drawable ID ，获取该id对应的</span></div><div class="line">            <span class="comment">// drawable的流对象，并最终获取drawable对象</span></div><div class="line">            Drawable drawable = getDrawable(); <span class="comment">//调用imageSpan中的方法获取drawable对象</span></div><div class="line">            canvas.save();</div><div class="line"></div><div class="line">            <span class="comment">//获取画笔的文字绘制时的具体测量数据</span></div><div class="line">            Paint.FontMetricsInt fm = paint.getFontMetricsInt();</div><div class="line"></div><div class="line">            <span class="comment">//系统原有方法，默认是Bottom模式)</span></div><div class="line">            <span class="keyword">int</span> transY = bottom - drawable.getBounds().bottom;</div><div class="line">            <span class="keyword">if</span> (mVerticalAlignment == ALIGN_BASELINE) &#123;</div><div class="line">                transY -= fm.descent;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mVerticalAlignment == ALIGN_FONTCENTER) &#123;    <span class="comment">//此处加入判断， 如果是自定义的居中对齐</span></div><div class="line">                <span class="comment">//与文字的中间线对齐（这种方式不论是否设置行间距都能保障文字的中间线和图片的中间线是对齐的）</span></div><div class="line">                <span class="comment">// y+ascent得到文字内容的顶部坐标，y+descent得到文字的底部坐标，（顶部坐标+底部坐标）/2=文字内容中间线坐标</span></div><div class="line">                transY = ((y + fm.descent) + (y + fm.ascent)) / <span class="number">2</span> - drawable.getBounds().bottom / <span class="number">2</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            canvas.translate(x, transY);</div><div class="line">            drawable.draw(canvas);</div><div class="line">            canvas.restore();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * 重写getSize方法，只有重写该方法后，才能保证不论是图片大于文字还是文字大于图片，都能实现中间对齐</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">(Paint paint, CharSequence text, <span class="keyword">int</span> start, <span class="keyword">int</span> end, Paint.FontMetricsInt fm)</span> </span>&#123;</div><div class="line">            Drawable d = getDrawable();</div><div class="line">            Rect rect = d.getBounds();</div><div class="line">            <span class="keyword">if</span> (fm != <span class="keyword">null</span>) &#123;</div><div class="line">                Paint.FontMetricsInt fmPaint = paint.getFontMetricsInt();</div><div class="line">                <span class="keyword">int</span> fontHeight = fmPaint.bottom - fmPaint.top;</div><div class="line">                <span class="keyword">int</span> drHeight = rect.bottom - rect.top;</div><div class="line"></div><div class="line">                <span class="keyword">int</span> top = drHeight / <span class="number">2</span> - fontHeight / <span class="number">4</span>;</div><div class="line">                <span class="keyword">int</span> bottom = drHeight / <span class="number">2</span> + fontHeight / <span class="number">4</span>;</div><div class="line"></div><div class="line">                fm.ascent = -bottom;</div><div class="line">                fm.top = -bottom;</div><div class="line">                fm.bottom = top;</div><div class="line">                fm.descent = top;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> rect.right;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>xml布局文件：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">              <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">              <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></div><div class="line">              <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:id</span>=<span class="string">"@+id/tv_test"</span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:background</span>=<span class="string">"#fffaa3"</span></div><div class="line">        <span class="attr">android:lineSpacingExtra</span>=<span class="string">"@dimen/dp100"</span></div><div class="line">        <span class="attr">android:textSize</span>=<span class="string">"16sp"</span>/&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure></p>
<!-- <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=songid&auto=1&height=66"></iframe> --></div>
    
      <p class="post-copyright">转载文章请链接上原文地址：<a class="post-copyright-link" href="http://dinson.win/2017/06/10/17-06-10/" title="http://dinson.win/2017/06/10/17-06-10/" target="_blank">http://dinson.win/2017/06/10/17-06-10/</a></p>

      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#图文混排的方式有哪些？"><span class="toc-text">图文混排的方式有哪些？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用SpannableString-ImageSpan怎么实现图文混排？"><span class="toc-text">使用SpannableString+ImageSpan怎么实现图文混排？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Paint-FontMetrics-是啥？"><span class="toc-text">Paint.FontMetrics 是啥？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义ImageSpan实现文字与图片居中对齐"><span class="toc-text">自定义ImageSpan实现文字与图片居中对齐</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#终极方案"><span class="toc-text">终极方案</span></a></li></ol>
          </div>
        </div>
      </div>
    
  
  
 
</article>

      <footer class="footer">
  <p class="footer-text">© 2016 - 2017 ❤ Powered by - DINSON</p>
   
  <span id="busuanzi_container_site_pv"><i class="iconfont icon-dianji"></i>&nbsp;&nbsp;<span id="busuanzi_value_site_pv"></span>Times</span>
  <span style="margin: 0.5em 0.5em">|</span>
  <span id="busuanzi_container_site_uv"><i class="iconfont icon-fangke"></i>&nbsp;&nbsp;<span id="busuanzi_value_site_uv"></span>Times</span>
  <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <p class="footer-text">一只穿着空气鞋碎花沙滩裤挂着大金链子叼着烟戴着墨镜翘着二郎腿边弹吉他边敲代码的程序猿</p>

  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</footer> 
    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
