<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="Android,设计模式,安卓入门,安卓高级,前端,JavaScript,h5,css3,Jquery">
  <meta name="description" content="null">
  <meta name="author" content="DINSON">
 
 
<meta name="keywords" content="Android,设计模式,安卓入门,安卓高级,前端,JavaScript,h5,css3,Jquery">


  
  <title>模仿手机QQ底部导航栏Icon拖拽效果</title>
  

  <link rel="alternate" href="/atom.xml" title="Android - Dinson - 酸奶布丁 - 国家一级码农" type="application/atom+xml">
  <link rel="canonical" href="http://dinson.win/2017/06/20/17-06-20/index.html">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_8ce77jkwodt5ipb9.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-home"></i><a href="/index.html" class="aside-menu-link" title="酸奶布丁">酸奶布丁</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-all"></i><a href="/archives/index.html" class="aside-menu-link" title="时间印记">时间印记</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-tag"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标记">分类标记</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-python"></i><a href="http://dinson.win/Python/index.html" class="aside-menu-link" title="Python">Python</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-jinglingqiu"></i><a href="http://dinson.win/Pokemon/" class="aside-menu-link" title="口袋妖怪">口袋妖怪</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-me"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-rss"></i><a href="/atom.xml" class="aside-menu-link" title="RSS">RSS</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-quxiao"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.jpg" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          Dinson
          
          <strong class="aside-avatar-STRONG">Android喵</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">面朝电脑--栀子花开</p>
      <ul class="aside-show-info" >
	  <li class="aside-show-item"><a href="https://github.com/DinsonCat" class="aside-show-link" target="_blank"><i class="aside-show-icon iconfont icon-github"></i></a></li>
        <li class="aside-show-item">
          <a href="javascript: void(0);" class="aside-show-link"   target="_blank"><i class="aside-show-icon iconfont icon-wechat"></i></a>
          <div class="aside-show-outside aside-show-outside_1">
            <img class="aside-show-IMG aside-show-IMG_1" src="/img/weixin.png" alt="微信"  >
          </div>
        </li>
        <li class="aside-show-item">
          <a href="javascript: void(0);" class="aside-show-link"   target="_blank"><i class="aside-show-icon iconfont icon-qq"></i></a>
          <div class="aside-show-outside">
            <img class="aside-show-IMG  " src="/img/qq.jpg"   alt="QQ">
          </div>
        </li>
		 
      </ul>
	
	 
    </div>
	
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">模仿手机QQ底部导航栏Icon拖拽效果</h1>
    <p class="post-meta">
      </span>
      
      <a href="/categories/Android嫡系/" class="post-categories">Android嫡系</a>
      
      
      <a href="/tags/自定义VIEW/"" class="post-tags"><i class="post-tags-icon iconfont icon-waixingren"></i>自定义VIEW</a>
      
	  
	  
		<span id="busuanzi_container_page_pv"  class="post-time"><i class="post-tags-icon iconfont icon-yuedu"></i>Views <span id="busuanzi_value_page_pv"></span> Times</span>
	  
	  
    </p>
    
  </header>
  <div class="post-content"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><blockquote>
<p>实现的方式有很多，我说一下我的思路：我的思路比较简单，无非就是上下两层图片可拖动的范围和速度不一样呗（大图标拖动范围和速度小于小图标拖动范围和速度）。</p>
</blockquote>
<p>PS（以第一个消息图标为例）：大图标指的是外面的气泡图标，小图标指的是气泡里面的眼睛和嘴巴图标。切图时将一张整体图片切成了这两个图标。具体可下载Demo参考里面的图片资源。<br>自定义属性</p>
<a id="more"></a>
<!-- 这是　　缩进--> 
<h2 id="自定义属性"><a href="#自定义属性" class="headerlink" title="自定义属性"></a>自定义属性</h2><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="built_in">resources</span>&gt;  </div><div class="line">    &lt;declare-styleable <span class="built_in">name</span>=<span class="string">"QQNaviView"</span>&gt;  </div><div class="line">        &lt;attr <span class="built_in">name</span>=<span class="string">"bigIconSrc"</span> <span class="built_in">format</span>=<span class="string">"reference"</span>/&gt;  </div><div class="line">        &lt;attr <span class="built_in">name</span>=<span class="string">"smallIconSrc"</span> <span class="built_in">format</span>=<span class="string">"reference"</span>/&gt;  </div><div class="line">        &lt;attr <span class="built_in">name</span>=<span class="string">"iconWidth"</span> <span class="built_in">format</span>=<span class="string">"dimension"</span>/&gt;  </div><div class="line">        &lt;attr <span class="built_in">name</span>=<span class="string">"iconHeight"</span> <span class="built_in">format</span>=<span class="string">"dimension"</span>/&gt;  </div><div class="line">        &lt;attr <span class="built_in">name</span>=<span class="string">"range"</span> <span class="built_in">format</span>=<span class="string">"float"</span>/&gt;  </div><div class="line">    &lt;/declare-styleable&gt;  </div><div class="line">&lt;/<span class="built_in">resources</span>&gt;</div></pre></td></tr></table></figure>
<p> 其中range为可拖动的范围（其实是倍数），默认值是1，不宜设置过大。</p>
<h2 id="主要的拖动代码"><a href="#主要的拖动代码" class="headerlink" title="主要的拖动代码"></a>主要的拖动代码</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">@<span class="function">Override  </span></div><div class="line"><span class="keyword">public</span> boolean <span class="title">onTouchEvent</span>(<span class="params">MotionEvent <span class="keyword">event</span></span>) &#123;  </div><div class="line">    <span class="keyword">float</span> x = <span class="keyword">event</span>.getX();  </div><div class="line">    <span class="keyword">float</span> y = <span class="keyword">event</span>.getY();  </div><div class="line">    <span class="keyword">switch</span> (<span class="keyword">event</span>.getAction())&#123;  </div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:  </div><div class="line">            lastX = x;  </div><div class="line">            lastY = y;  </div><div class="line">            <span class="keyword">break</span>;  </div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE:  </div><div class="line">            <span class="keyword">float</span> deltaX = x - lastX;  </div><div class="line">            <span class="keyword">float</span> deltaY = y - lastY;  </div><div class="line"></div><div class="line">            moveEvent(mBigIcon, deltaX, deltaY, mSmallRadius);  </div><div class="line">            <span class="comment">//因为可拖动大半径是小半径的1.5倍， 因此这里x,y也相应乘1.5  </span></div><div class="line">            moveEvent(mSmallIcon, <span class="number">1.5</span>f * deltaX, <span class="number">1.5</span>f * deltaY, mBigRadius);  </div><div class="line">            <span class="keyword">break</span>;  </div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:  </div><div class="line">            <span class="comment">//抬起时复位  </span></div><div class="line">            mBigIcon.setX(<span class="number">0</span>);  </div><div class="line">            mBigIcon.setY(<span class="number">0</span>);  </div><div class="line">            mSmallIcon.setX(<span class="number">0</span>);  </div><div class="line">            mSmallIcon.setY(<span class="number">0</span>);  </div><div class="line">            <span class="keyword">break</span>;  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">return</span> super.onTouchEvent(<span class="keyword">event</span>);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里先得到X轴拖动的距离deltaX和Y轴拖动的距离deltaY，大图标对应小半径，小图标对应大半径。然后看moveEvent方法：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">private void moveEvent(View <span class="built_in">view</span>, <span class="built_in">float</span> deltaX, <span class="built_in">float</span> deltaY, <span class="built_in">float</span> <span class="built_in">radius</span>)&#123;  </div><div class="line">  </div><div class="line">    //先计算拖动距离  </div><div class="line">    <span class="built_in">float</span> distance = getDistance(deltaX, deltaY);  </div><div class="line"></div><div class="line">    //拖动的方位角，<span class="built_in">atan2</span>出来的角度是带正负号的  </div><div class="line">    double degree = Math.<span class="built_in">atan2</span>(deltaY, deltaX);  </div><div class="line"></div><div class="line">    //如果大于临界半径就不能再往外拖了  </div><div class="line">    <span class="keyword">if</span> (distance &gt; <span class="built_in">radius</span>)&#123;  </div><div class="line">        <span class="built_in">view</span>.setX(<span class="built_in">view</span>.getLeft() + (<span class="built_in">float</span>) (<span class="built_in">radius</span> * Math.<span class="built_in">cos</span>(degree)));  </div><div class="line">        <span class="built_in">view</span>.setY(<span class="built_in">view</span>.getTop() + (<span class="built_in">float</span>) (<span class="built_in">radius</span> * Math.<span class="built_in">sin</span>(degree)));  </div><div class="line">    &#125;<span class="keyword">else</span> &#123;  </div><div class="line">        <span class="built_in">view</span>.setX(<span class="built_in">view</span>.getLeft() + deltaX);  </div><div class="line">        <span class="built_in">view</span>.setY(<span class="built_in">view</span>.getTop() + deltaY);  </div><div class="line">    &#125;  </div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>方法很简单，注释结合这张图就一目了然了，主要是注意在抬起时图标复位就好了。</p>
<p><img src="http://ondlsj2sn.bkt.clouddn.com/FnR-HX50f9CT6__4u2VooWRtZLSN.png" alt=""></p>
<h2 id="简单看一下初始化"><a href="#简单看一下初始化" class="headerlink" title="简单看一下初始化"></a>简单看一下初始化</h2><blockquote>
<p>由于图标下面一般会带文字，因此直接继承了LinearLayout，并且默认设置成了垂直排列。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public QQNaviView(@NonNull Context <span class="keyword">context</span>, @Nullable AttributeSet attrs, @AttrRes <span class="keyword">int</span> defStyleAttr) &#123;  </div><div class="line">    <span class="keyword">super</span>(<span class="keyword">context</span>, attrs, defStyleAttr);  </div><div class="line">  </div><div class="line">    mContext = <span class="keyword">context</span>;  </div><div class="line">  </div><div class="line">    TypedArray ta = <span class="keyword">context</span><span class="variable">.obtainStyledAttributes</span>(attrs, R<span class="variable">.styleable</span><span class="variable">.QQNaviView</span>, defStyleAttr, <span class="number">0</span>);  </div><div class="line">    mBigIconSrc = ta<span class="variable">.getResourceId</span>(R<span class="variable">.styleable</span><span class="variable">.QQNaviView_bigIconSrc</span>, R<span class="variable">.drawable</span><span class="variable">.big</span>);  </div><div class="line">    mSmallIconSrc = ta<span class="variable">.getResourceId</span>(R<span class="variable">.styleable</span><span class="variable">.QQNaviView_smallIconSrc</span>, R<span class="variable">.drawable</span><span class="variable">.small</span>);  </div><div class="line">    mIconWidth = ta<span class="variable">.getDimension</span>(R<span class="variable">.styleable</span><span class="variable">.QQNaviView_iconWidth</span>, dp2px(<span class="keyword">context</span>, <span class="number">60</span>));  </div><div class="line">    mIconHeight = ta<span class="variable">.getDimension</span>(R<span class="variable">.styleable</span><span class="variable">.QQNaviView_iconHeight</span>, dp2px(<span class="keyword">context</span>, <span class="number">60</span>));  </div><div class="line">    mRange = ta<span class="variable">.getFloat</span>(R<span class="variable">.styleable</span><span class="variable">.QQNaviView_range</span>, <span class="number">1</span>);  </div><div class="line">    ta<span class="variable">.recycle</span>();  </div><div class="line">  </div><div class="line">    <span class="comment">//默认垂直排列  </span></div><div class="line">    setOrientation(LinearLayout<span class="variable">.VERTICAL</span>);  </div><div class="line">  </div><div class="line">    init(<span class="keyword">context</span>);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>在init方法中进行了布局文件的绑定，并且让该view水平居中。</p>
</blockquote>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">private void init(<span class="built_in">Context</span> <span class="built_in">context</span>) &#123;  </div><div class="line">    mView = inflate(<span class="built_in">context</span>, R.layout.view_icon, null)<span class="comment">;  </span></div><div class="line">    mBigIcon = (ImageView) mView.findViewById(R.id.iv_big)<span class="comment">;  </span></div><div class="line">    mSmallIcon = (ImageView) mView.findViewById(R.id.iv_small)<span class="comment">;  </span></div><div class="line">  </div><div class="line">    mBigIcon.setImageResource(mBigIconSrc)<span class="comment">;  </span></div><div class="line">    mSmallIcon.setImageResource(mSmallIconSrc)<span class="comment">;  </span></div><div class="line">  </div><div class="line">    setWidthAndHeight(mBigIcon)<span class="comment">;  </span></div><div class="line">    setWidthAndHeight(mSmallIcon)<span class="comment">;  </span></div><div class="line">  </div><div class="line">    LayoutParams lp = new LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT)<span class="comment">;  </span></div><div class="line">    lp.gravity = Gravity.CENTER_HORIZONTAL<span class="comment">;  </span></div><div class="line">    mView.setLayoutParams(lp)<span class="comment">;  </span></div><div class="line">    <span class="keyword">addView(mView); </span> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>这里值得注意的是onMeasure方法。由于图标可以往外拖动，所以要给ImageView一个默认的padding，不然拖动时最外面部分会消失。</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">@<span class="function">Override  </span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> &#123;  </div><div class="line">        setupView();  </div><div class="line">        measureDimension(widthMeasureSpec, heightMeasureSpec);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">/** </span></div><div class="line">     * 确定view以及拖动相关参数 </div><div class="line">     */  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupView</span><span class="params">()</span> </span>&#123;  </div><div class="line">  </div><div class="line">        <span class="comment">//根据view的宽高确定可拖动半径的大小  </span></div><div class="line">        mSmallRadius = <span class="number">0.1f</span> * Math.min(mView.getWidth(), mView.getHeight()) * mRange;  </div><div class="line">        mBigRadius = <span class="number">1.5f</span> * mSmallRadius;  </div><div class="line">  </div><div class="line">        <span class="comment">//设置imageview的padding，不然拖动时图片边缘部分会消失  </span></div><div class="line">        <span class="keyword">int</span> padding = (<span class="keyword">int</span>) mBigRadius;  </div><div class="line">        mBigIcon.setPadding(padding, padding, padding, padding);  </div><div class="line">        mSmallIcon.setPadding(padding, padding, padding, padding);  </div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>然后就没啥好说了，直接看源码吧。</p>
<h2 id="源码："><a href="#源码：" class="headerlink" title="源码："></a>源码：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QQNaviView</span> <span class="keyword">extends</span> <span class="title">LinearLayout</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"QQNaviView"</span>;  </div><div class="line">  </div><div class="line">    <span class="keyword">private</span> Context mContext;  </div><div class="line">  </div><div class="line">    <span class="comment">/* 主view */</span>  </div><div class="line">    <span class="keyword">private</span> View mView;  </div><div class="line">  </div><div class="line">    <span class="comment">/* 外层icon/拖动幅度较小icon */</span>  </div><div class="line">    <span class="keyword">private</span> ImageView mBigIcon;  </div><div class="line">  </div><div class="line">    <span class="comment">/* 里层icon/拖动幅度较大icon */</span>  </div><div class="line">    <span class="keyword">private</span> ImageView mSmallIcon;  </div><div class="line">  </div><div class="line">    <span class="comment">/* 外层icon资源 */</span>  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mBigIconSrc;  </div><div class="line">  </div><div class="line">    <span class="comment">/* 里面icon资源 */</span>  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSmallIconSrc;  </div><div class="line">  </div><div class="line">    <span class="comment">/* icon宽度 */</span>  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mIconWidth;  </div><div class="line">  </div><div class="line">    <span class="comment">/* icon高度 */</span>  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mIconHeight;  </div><div class="line">  </div><div class="line">    <span class="comment">/* 拖动幅度较大半径 */</span>  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mBigRadius;  </div><div class="line">  </div><div class="line">    <span class="comment">/* 拖动幅度小半径 */</span>  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mSmallRadius;  </div><div class="line">  </div><div class="line">    <span class="comment">/* 拖动范围 可调 */</span>  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mRange;  </div><div class="line">  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> lastX;  </div><div class="line">  </div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> lastY;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">QQNaviView</span><span class="params">(@NonNull Context context)</span> </span>&#123;  </div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">QQNaviView</span><span class="params">(@NonNull Context context, @Nullable AttributeSet attrs)</span> </span>&#123;  </div><div class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">QQNaviView</span><span class="params">(@NonNull Context context, @Nullable AttributeSet attrs, @AttrRes <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;  </div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);  </div><div class="line">  </div><div class="line">        mContext = context;  </div><div class="line">  </div><div class="line">        TypedArray ta = context.obtainStyledAttributes(attrs, R.styleable.QQNaviView, defStyleAttr, <span class="number">0</span>);  </div><div class="line">        mBigIconSrc = ta.getResourceId(R.styleable.QQNaviView_bigIconSrc, R.drawable.big);  </div><div class="line">        mSmallIconSrc = ta.getResourceId(R.styleable.QQNaviView_smallIconSrc, R.drawable.small);  </div><div class="line">        mIconWidth = ta.getDimension(R.styleable.QQNaviView_iconWidth, dp2px(context, <span class="number">60</span>));  </div><div class="line">        mIconHeight = ta.getDimension(R.styleable.QQNaviView_iconHeight, dp2px(context, <span class="number">60</span>));  </div><div class="line">        mRange = ta.getFloat(R.styleable.QQNaviView_range, <span class="number">1</span>);  </div><div class="line">        ta.recycle();  </div><div class="line">  </div><div class="line">        <span class="comment">//默认垂直排列  </span></div><div class="line">        setOrientation(LinearLayout.VERTICAL);  </div><div class="line">  </div><div class="line">        init(context);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;  </div><div class="line">        mView = inflate(context, R.layout.view_icon, <span class="keyword">null</span>);  </div><div class="line">        mBigIcon = (ImageView) mView.findViewById(R.id.iv_big);  </div><div class="line">        mSmallIcon = (ImageView) mView.findViewById(R.id.iv_small);  </div><div class="line">  </div><div class="line">        mBigIcon.setImageResource(mBigIconSrc);  </div><div class="line">        mSmallIcon.setImageResource(mSmallIconSrc);  </div><div class="line">  </div><div class="line">        setWidthAndHeight(mBigIcon);  </div><div class="line">        setWidthAndHeight(mSmallIcon);  </div><div class="line">  </div><div class="line">        LayoutParams lp = <span class="keyword">new</span> LayoutParams(ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT);  </div><div class="line">        lp.gravity = Gravity.CENTER_HORIZONTAL;  </div><div class="line">        mView.setLayoutParams(lp);  </div><div class="line">        addView(mView);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">/** </span></div><div class="line">     * 设置icon宽高 </div><div class="line">     * <span class="doctag">@param</span> view </div><div class="line">     */  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setWidthAndHeight</span><span class="params">(View view)</span></span>&#123;  </div><div class="line">        FrameLayout.LayoutParams lp = (FrameLayout.LayoutParams) view.getLayoutParams();  </div><div class="line">        lp.width = (<span class="keyword">int</span>) mIconWidth;  </div><div class="line">        lp.height = (<span class="keyword">int</span>) mIconHeight;  </div><div class="line">        view.setLayoutParams(lp);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </div><div class="line">        setupView();  </div><div class="line">        measureDimension(widthMeasureSpec, heightMeasureSpec);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">/** </span></div><div class="line">     * 确定view以及拖动相关参数 </div><div class="line">     */  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupView</span><span class="params">()</span> </span>&#123;  </div><div class="line">  </div><div class="line">        <span class="comment">//根据view的宽高确定可拖动半径的大小  </span></div><div class="line">        mSmallRadius = <span class="number">0.1f</span> * Math.min(mView.getWidth(), mView.getHeight()) * mRange;  </div><div class="line">        mBigRadius = <span class="number">1.5f</span> * mSmallRadius;  </div><div class="line">  </div><div class="line">        <span class="comment">//设置imageview的padding，不然拖动时图片边缘部分会消失  </span></div><div class="line">        <span class="keyword">int</span> padding = (<span class="keyword">int</span>) mBigRadius;  </div><div class="line">        mBigIcon.setPadding(padding, padding, padding, padding);  </div><div class="line">        mSmallIcon.setPadding(padding, padding, padding, padding);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">measureDimension</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;  </div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sizeWidth = MeasureSpec.getSize(widthMeasureSpec);  </div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sizeHeight = MeasureSpec.getSize(heightMeasureSpec);  </div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> modeWidth = MeasureSpec.getMode(widthMeasureSpec);  </div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> modeHeight = MeasureSpec.getMode(heightMeasureSpec);  </div><div class="line">        <span class="keyword">int</span> width = <span class="number">0</span>;  </div><div class="line">        <span class="keyword">int</span> height = <span class="number">0</span>;  </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; getChildCount(); i++)&#123;  </div><div class="line">            <span class="keyword">final</span> View child = getChildAt(i);  </div><div class="line">            <span class="keyword">if</span> (child.getVisibility() != GONE)&#123;  </div><div class="line">                measureChild(child, widthMeasureSpec, heightMeasureSpec);  </div><div class="line">                LayoutParams lp = (LayoutParams) child.getLayoutParams();  </div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childWidth = child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin;  </div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childHeight = child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin;  </div><div class="line">                width += childWidth;  </div><div class="line">                height += childHeight;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">        setMeasuredDimension((modeWidth == MeasureSpec.EXACTLY) ? sizeWidth : width,  </div><div class="line">                (modeHeight == MeasureSpec.EXACTLY) ? sizeHeight : height);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;  </div><div class="line">        <span class="keyword">int</span> childLeft;  </div><div class="line">        <span class="keyword">int</span> childTop = <span class="number">0</span>;  </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; getChildCount(); i ++)&#123;  </div><div class="line">            <span class="keyword">final</span> View child = getChildAt(i);  </div><div class="line">            LayoutParams lp = (LayoutParams) child.getLayoutParams();  </div><div class="line">            <span class="keyword">if</span> (child.getVisibility() != GONE)&#123;  </div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childWidth = child.getMeasuredWidth();  </div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childHeight = child.getMeasuredHeight();  </div><div class="line">                <span class="comment">//水平居中显示  </span></div><div class="line">                childLeft = (getWidth() - childWidth) / <span class="number">2</span>;  </div><div class="line">                <span class="comment">//当前子view的top  </span></div><div class="line">                childTop += lp.topMargin;  </div><div class="line">                child.layout(childLeft, childTop, childLeft + childWidth, childTop + childHeight);  </div><div class="line">                <span class="comment">//下一个view的top是当前子view的top + height + bottomMargin  </span></div><div class="line">                childTop += childHeight + lp.bottomMargin;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;  </div><div class="line">        <span class="keyword">float</span> x = event.getX();  </div><div class="line">        <span class="keyword">float</span> y = event.getY();  </div><div class="line">        <span class="keyword">switch</span> (event.getAction())&#123;  </div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:  </div><div class="line">                lastX = x;  </div><div class="line">                lastY = y;  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:  </div><div class="line">                <span class="keyword">float</span> deltaX = x - lastX;  </div><div class="line">                <span class="keyword">float</span> deltaY = y - lastY;  </div><div class="line">  </div><div class="line">                moveEvent(mBigIcon, deltaX, deltaY, mSmallRadius);  </div><div class="line">                <span class="comment">//因为可拖动大半径是小半径的1.5倍， 因此这里x,y也相应乘1.5  </span></div><div class="line">                moveEvent(mSmallIcon, <span class="number">1.5f</span> * deltaX, <span class="number">1.5f</span> * deltaY, mBigRadius);  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:  </div><div class="line">                <span class="comment">//抬起时复位  </span></div><div class="line">                mBigIcon.setX(<span class="number">0</span>);  </div><div class="line">                mBigIcon.setY(<span class="number">0</span>);  </div><div class="line">                mSmallIcon.setX(<span class="number">0</span>);  </div><div class="line">                mSmallIcon.setY(<span class="number">0</span>);  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(event);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">/** </span></div><div class="line">     * 拖动事件 </div><div class="line">     * <span class="doctag">@param</span> view </div><div class="line">     * <span class="doctag">@param</span> deltaX </div><div class="line">     * <span class="doctag">@param</span> deltaY </div><div class="line">     * <span class="doctag">@param</span> radius </div><div class="line">     */  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">moveEvent</span><span class="params">(View view, <span class="keyword">float</span> deltaX, <span class="keyword">float</span> deltaY, <span class="keyword">float</span> radius)</span></span>&#123;  </div><div class="line">  </div><div class="line">        <span class="comment">//先计算拖动距离  </span></div><div class="line">        <span class="keyword">float</span> distance = getDistance(deltaX, deltaY);  </div><div class="line">  </div><div class="line">        <span class="comment">//拖动的方位角，atan2出来的角度是带正负号的  </span></div><div class="line">        <span class="keyword">double</span> degree = Math.atan2(deltaY, deltaX);  </div><div class="line">  </div><div class="line">        <span class="comment">//如果大于临界半径就不能再往外拖了  </span></div><div class="line">        <span class="keyword">if</span> (distance &gt; radius)&#123;  </div><div class="line">            view.setX(view.getLeft() + (<span class="keyword">float</span>) (radius * Math.cos(degree)));  </div><div class="line">            view.setY(view.getTop() + (<span class="keyword">float</span>) (radius * Math.sin(degree)));  </div><div class="line">        &#125;<span class="keyword">else</span> &#123;  </div><div class="line">            view.setX(view.getLeft() + deltaX);  </div><div class="line">            view.setY(view.getTop() + deltaY);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">dp2px</span><span class="params">(Context context, <span class="keyword">float</span> dpVal)</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP,  </div><div class="line">                dpVal, context.getResources().getDisplayMetrics());  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">float</span> <span class="title">getDistance</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y)</span></span>&#123;  </div><div class="line">        <span class="keyword">return</span> (<span class="keyword">float</span>) Math.sqrt(x * x + y * y);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBigIcon</span><span class="params">(<span class="keyword">int</span> res)</span></span>&#123;  </div><div class="line">        mBigIcon.setImageResource(res);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSmallIcon</span><span class="params">(<span class="keyword">int</span> res)</span></span>&#123;  </div><div class="line">        mSmallIcon.setImageResource(res);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIconWidthAndHeight</span><span class="params">(<span class="keyword">float</span> width, <span class="keyword">float</span> height)</span></span>&#123;  </div><div class="line">        mIconWidth = dp2px(mContext, width);  </div><div class="line">        mIconHeight = dp2px(mContext, height);  </div><div class="line">        setWidthAndHeight(mBigIcon);  </div><div class="line">        setWidthAndHeight(mSmallIcon);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRange</span><span class="params">(<span class="keyword">float</span> range)</span></span>&#123;  </div><div class="line">        mRange = range;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>bigIconSrc</td>
<td>大图标资源</td>
</tr>
<tr>
<td>smallIconSrc</td>
<td>小图标资源</td>
</tr>
<tr>
<td>iconWidth</td>
<td>图标宽度</td>
</tr>
<tr>
<td>iconHeight</td>
<td>图标高度</td>
</tr>
<tr>
<td>range</td>
<td>可拖动范围</td>
</tr>
</tbody>
</table>
<!-- <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=songid&auto=1&height=66"></iframe> --></div>
    
      <p class="post-copyright">转载文章请链接上原文地址：<a class="post-copyright-link" href="http://dinson.win/2017/06/20/17-06-20/" title="http://dinson.win/2017/06/20/17-06-20/" target="_blank">http://dinson.win/2017/06/20/17-06-20/</a></p>

      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义属性"><span class="toc-text">自定义属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#主要的拖动代码"><span class="toc-text">主要的拖动代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#简单看一下初始化"><span class="toc-text">简单看一下初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#源码："><span class="toc-text">源码：</span></a></li></ol>
          </div>
        </div>
      </div>
    
  
  
 
</article>

      <footer class="footer">
  <p class="footer-text">© 2016 - 2017 ❤ Powered by - DINSON</p>
   
  <span id="busuanzi_container_site_pv"><i class="iconfont icon-dianji"></i>&nbsp;&nbsp;<span id="busuanzi_value_site_pv"></span>Times</span>
  <span style="margin: 0.5em 0.5em">|</span>
  <span id="busuanzi_container_site_uv"><i class="iconfont icon-fangke"></i>&nbsp;&nbsp;<span id="busuanzi_value_site_uv"></span>Times</span>
  <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <p class="footer-text">一只穿着空气鞋碎花沙滩裤挂着大金链子叼着烟戴着墨镜翘着二郎腿边弹吉他边敲代码的程序猿</p>

  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</footer> 
    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
