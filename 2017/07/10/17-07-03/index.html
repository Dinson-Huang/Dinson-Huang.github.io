<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="Android,设计模式,安卓入门,安卓高级,前端,JavaScript,h5,css3,Jquery">
  <meta name="description" content="null">
  <meta name="author" content="DINSON">
 
 
<meta name="keywords" content="Android,设计模式,安卓入门,安卓高级,前端,JavaScript,h5,css3,Jquery">


  
  <title>在百度地图上绘制运动轨迹图及相关事件处理</title>
  

  <link rel="alternate" href="/atom.xml" title="Android - Dinson - 酸奶布丁 - 国家一级码农" type="application/atom+xml">
  <link rel="canonical" href="http://dinson.win/2017/07/10/17-07-03/index.html">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_8ce77jkwodt5ipb9.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-home"></i><a href="/index.html" class="aside-menu-link" title="酸奶布丁">酸奶布丁</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-all"></i><a href="/archives/index.html" class="aside-menu-link" title="时间印记">时间印记</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-tag"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标记">分类标记</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-python"></i><a href="http://dinson.win/Python/index.html" class="aside-menu-link" title="Python">Python</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-jinglingqiu"></i><a href="http://dinson.win/Pokemon/" class="aside-menu-link" title="口袋妖怪">口袋妖怪</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-me"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-rss"></i><a href="/atom.xml" class="aside-menu-link" title="RSS">RSS</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-quxiao"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.jpg" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          Dinson
          
          <strong class="aside-avatar-STRONG">Android喵</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">面朝电脑--栀子花开</p>
      <ul class="aside-show-info" >
	  <li class="aside-show-item"><a href="https://github.com/DinsonCat" class="aside-show-link" target="_blank"><i class="aside-show-icon iconfont icon-github"></i></a></li>
        <li class="aside-show-item">
          <a href="javascript: void(0);" class="aside-show-link"   target="_blank"><i class="aside-show-icon iconfont icon-wechat"></i></a>
          <div class="aside-show-outside aside-show-outside_1">
            <img class="aside-show-IMG aside-show-IMG_1" src="/img/weixin.png" alt="微信"  >
          </div>
        </li>
        <li class="aside-show-item">
          <a href="javascript: void(0);" class="aside-show-link"   target="_blank"><i class="aside-show-icon iconfont icon-qq"></i></a>
          <div class="aside-show-outside">
            <img class="aside-show-IMG  " src="/img/qq.jpg"   alt="QQ">
          </div>
        </li>
		 
      </ul>
	
	 
    </div>
	
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">在百度地图上绘制运动轨迹图及相关事件处理</h1>
    <p class="post-meta">
      </span>
      
      
	  
	  
		<span id="busuanzi_container_page_pv"  class="post-time"><i class="post-tags-icon iconfont icon-yuedu"></i>Views <span id="busuanzi_value_page_pv"></span> Times</span>
	  
	  
    </p>
    
  </header>
  <div class="post-content"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><blockquote>
<p>上篇文章讲述了如何在地图显示位置点，这篇文章主要讲述如何在地图上画运动轨迹，以及地图图层点击事件的处理。</p>
</blockquote>
<p>本篇将要实现的效果</p>
<ol>
<li>跑步结束后，静态的画出整个运动轨迹</li>
<li>跑步过程中，时时动态的画运动轨迹<br>很多运动类的app都有画出跑步者运动轨迹的需求，拿咕咚来说，我们看一下它的效果图： </li>
</ol>
<a id="more"></a>
<!-- 这是　　缩进-->
<p>如何实现：</p>
<ol>
<li>将点与点连成线，在百度地图MapView上画出线条图层；</li>
<li>获取定位点List<latlng>：通过百度定位sdk：LocationClient类获取，户外运动画运动轨迹，要求位置点的精度高，所以我们必须使用gps定位类型的位置结果。</latlng></li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//允许使用gps定位</span></div><div class="line">mOption.setOpenGps(<span class="literal">true</span>);</div></pre></td></tr></table></figure>
<h2 id="静态画整个运动轨迹"><a href="#静态画整个运动轨迹" class="headerlink" title="静态画整个运动轨迹"></a>静态画整个运动轨迹</h2><h3 id="画轨迹"><a href="#画轨迹" class="headerlink" title="画轨迹"></a>画轨迹</h3><figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//伪代码</span></div><div class="line">public void onCreate()&#123;</div><div class="line">  <span class="comment">// 地图初始化</span></div><div class="line">  <span class="type">MapView</span> mMapView = (<span class="type">MapView</span>) findViewById(<span class="type">R</span>.id.bmapView);</div><div class="line">  <span class="type">BaiduMap</span> mBaiduMap = mMapView.getMap();</div><div class="line">  <span class="comment">// 开启定位图层</span></div><div class="line">  mBaiduMap.setMyLocationEnabled(<span class="literal">true</span>);</div><div class="line"></div><div class="line">  <span class="comment">//获取运动后的定位点</span></div><div class="line">  coordinateConvert();</div><div class="line"></div><div class="line">  <span class="comment">//设置缩放中点LatLng target，和缩放比例          </span></div><div class="line">  <span class="type">MapStatus</span>.<span class="type">Builder</span> builder = <span class="function"><span class="keyword">new</span> <span class="title">MapStatus</span>.<span class="title">Builder</span>();</span></div><div class="line">  <span class="title">builder</span>.<span class="title">target</span>(target).<span class="title">zoom</span>(<span class="number">18</span>f);</div><div class="line"></div><div class="line">  <span class="comment">//地图设置缩放状态</span></div><div class="line">  <span class="title">mBaiduMap</span>.<span class="title">animateMapStatus</span>(<span class="type">MapStatusUpdateFactory</span>.newMapStatus(builder.build()));</div><div class="line"></div><div class="line">  /**</div><div class="line">  * 配置线段图层参数类： <span class="title">PolylineOptions</span></div><div class="line">  * <span class="title">ooPolyline</span>.<span class="title">width</span>(<span class="number">13</span>)：线宽</div><div class="line">  * <span class="title">ooPolyline</span>.<span class="title">color</span>(<span class="number">0xAAFF0000</span>)：线条颜色红色</div><div class="line">  * <span class="title">ooPolyline</span>.<span class="title">points</span>(latLngs)：<span class="title">List</span>&lt;<span class="title">LatLng</span>&gt; <span class="title">latLngs</span>位置点，将相邻点与点连成线就成了轨迹了</div><div class="line">  */</div><div class="line">  <span class="title">OverlayOptions</span> <span class="title">ooPolyline</span> = <span class="title">new</span> <span class="title">PolylineOptions</span>().<span class="title">width</span>(<span class="number">13</span>).<span class="title">color</span>(<span class="number">0xAAFF0000</span>).<span class="title">points</span>(latLngs);</div><div class="line"></div><div class="line">  <span class="comment">//在地图上画出线条图层，mPolyline：线条图层</span></div><div class="line">  <span class="title">mPolyline</span> = (<span class="type">Polyline</span>) <span class="title">mBaiduMap</span>.<span class="title">addOverlay</span>(ooPolyline);</div><div class="line">  <span class="title">mPolyline</span>.<span class="title">setZIndex</span>(<span class="number">3</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 我这里是在google地图取下来的wgs84坐标集合Const.googleWGS84，模拟的运动后获取的坐标集合，</div><div class="line">   所以需要转化成百度坐标；实际应该是将定位sdk返回的位置点加入到位置集合中，</div><div class="line">   定位sdk需要设置返回坐标为百度坐标：mOption.setCoorType("bd09ll")，这样就直接用，不用转换了。</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span>  coordinateConvert()&#123;</div><div class="line">  <span class="comment">//百度坐标转化工具类CoordinateConverter </span></div><div class="line">  CoordinateConverter converter  = <span class="keyword">new</span> CoordinateConverter(); </div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">  * 设置需要转化的坐标类型</div><div class="line">    CoordType.COMMON：google地图、腾讯地图、高德地图所用坐标</div><div class="line">    CoordType.GPS：设备采集的原始GPS坐标</div><div class="line">  */</div><div class="line">  converter.<span class="keyword">from</span>(CoordType.COMMON);</div><div class="line"></div><div class="line">  <span class="keyword">double</span> lanSum = <span class="number">0</span>;</div><div class="line">  <span class="keyword">double</span> lonSum = <span class="number">0</span>;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Const.googleWGS84.length; i++) &#123;</div><div class="line">    <span class="comment">//"39.881970,116.456218"</span></div><div class="line">    String[] ll = Const.googleWGS84[i].split(<span class="string">","</span>);</div><div class="line">    LatLng sourceLatLng = <span class="keyword">new</span> LatLng(<span class="keyword">Double</span>.valueOf(ll[<span class="number">0</span>]), <span class="keyword">Double</span>.valueOf(ll[<span class="number">1</span>]));</div><div class="line">    converter.coord(sourceLatLng);  <span class="comment">//需要转化的坐标点</span></div><div class="line">    LatLng desLatLng = converter.convert();  <span class="comment">//转化成百度坐标点</span></div><div class="line">    latLngs.add(desLatLng);<span class="comment">//加入定位点集合</span></div><div class="line">    lanSum += desLatLng.latitude;</div><div class="line">    lonSum += desLatLng.longitude;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//我这里设置地图的缩放中心点为所有点的几何中心点</span></div><div class="line">  target = <span class="keyword">new</span> LatLng(lanSum<span class="regexp">/latLngs.size(), lonSum/</span>latLngs.<span class="keyword">size</span>());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="添加起始图标图层、点击图层响应事件"><a href="#添加起始图标图层、点击图层响应事件" class="headerlink" title="添加起始图标图层、点击图层响应事件"></a>添加起始图标图层、点击图层响应事件</h3><figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//始点图层图标</span></div><div class="line"><span class="type">BitmapDescriptor</span> startBD= <span class="type">BitmapDescriptorFactory</span></div><div class="line">            .fromResource(<span class="type">R</span>.drawable.ic_me_history_startpoint);</div><div class="line"><span class="comment">//终点图层图标</span></div><div class="line"><span class="type">BitmapDescriptor</span> finishBD= <span class="type">BitmapDescriptorFactory</span></div><div class="line">            .fromResource(<span class="type">R</span>.drawable.ic_me_history_finishpoint);</div><div class="line"></div><div class="line"><span class="comment">//地图中显示信息窗口</span></div><div class="line"><span class="type">InfoWindow</span> mInfoWindow;</div><div class="line"></div><div class="line"><span class="type">MarkerOptions</span> oStart = <span class="function"><span class="keyword">new</span> <span class="title">MarkerOptions</span>();<span class="comment">//地图标记类型的图层参数配置类 </span></span></div><div class="line"><span class="title">oStart</span>.<span class="title">position</span>(latLngs.get(<span class="number">0</span>));<span class="comment">//图层位置点，第一个点为起点</span></div><div class="line"><span class="title">oStart</span>.<span class="title">icon</span>(startBD);<span class="comment">//设置图层图片</span></div><div class="line"><span class="title">oStart</span>.<span class="title">zIndex</span>(<span class="number">1</span>);<span class="comment">//设置图层Index</span></div><div class="line"><span class="comment">//添加起点图层</span></div><div class="line"><span class="title">Marker</span> <span class="title">mMarkerA</span> = (<span class="type">Marker</span>) (mBaiduMap.addOverlay(oStart)); </div><div class="line"></div><div class="line"><span class="comment">//添加终点图层</span></div><div class="line"><span class="title">MarkerOptions</span> <span class="title">oFinish</span> = <span class="title">new</span> <span class="title">MarkerOptions</span>().<span class="title">position</span>(latLngs.get(latLngs.size()-1)).<span class="title">icon</span>(finishBD).<span class="title">zIndex</span>(<span class="number">2</span>);</div><div class="line"><span class="title">Marker</span> <span class="title">mMarkerB</span> = (<span class="type">Marker</span>) (mBaiduMap.addOverlay(oFinish));</div><div class="line"></div><div class="line"><span class="comment">//设置图层点击监听回调</span></div><div class="line"><span class="title">mBaiduMap</span>.<span class="title">setOnMarkerClickListener</span>(new <span class="type">OnMarkerClickListener</span>() &#123;</div><div class="line">  <span class="title">public</span> <span class="title">boolean</span> <span class="title">onMarkerClick</span>(final <span class="type">Marker</span> marker) &#123;</div><div class="line">    <span class="title">if</span> (marker.getZIndex() == <span class="title">mMarkerA</span>.<span class="title">getZIndex</span>() ) &#123;<span class="comment">//如果是起始点图层</span></div><div class="line">      <span class="title">TextView</span> <span class="title">textView</span> = <span class="title">new</span> <span class="title">TextView</span>(getApplicationContext());</div><div class="line">      <span class="title">textView</span>.<span class="title">setText</span>("起点");</div><div class="line">      <span class="title">textView</span>.<span class="title">setTextColor</span>(<span class="type">Color</span>.<span class="type">BLACK</span>);</div><div class="line">      <span class="title">textView</span>.<span class="title">setGravity</span>(<span class="type">Gravity</span>.<span class="type">CENTER</span>);</div><div class="line">      <span class="title">textView</span>.<span class="title">setBackgroundResource</span>(<span class="type">R</span>.drawable.popup);</div><div class="line"></div><div class="line">      <span class="comment">//设置信息窗口点击回调</span></div><div class="line">      <span class="title">OnInfoWindowClickListener</span> <span class="title">listener</span> = <span class="title">new</span> <span class="title">OnInfoWindowClickListener</span>() &#123;</div><div class="line">        <span class="title">public</span> <span class="title">void</span> <span class="title">onInfoWindowClick</span>() &#123;</div><div class="line">          <span class="comment">//这里是主线线程，可以实现自己的一些功能</span></div><div class="line">          <span class="title">Toast</span>.<span class="title">makeText</span>(getApplicationContext(),"这里是起点", <span class="title">Toast</span>.<span class="title">LENGTH_SHORT</span>).<span class="title">show</span>();</div><div class="line">          <span class="title">mBaiduMap</span>.<span class="title">hideInfoWindow</span>();<span class="comment">//隐藏信息窗口</span></div><div class="line">        &#125;</div><div class="line">      &#125;;</div><div class="line"></div><div class="line">      <span class="title">LatLng</span> <span class="title">latLng</span> = <span class="title">marker</span>.<span class="title">getPosition</span>();<span class="comment">//信息窗口显示的位置点</span></div><div class="line"></div><div class="line">      /**</div><div class="line">      * 通过传入的 <span class="title">bitmap</span> <span class="title">descriptor</span> 构造一个 <span class="title">InfoWindow</span></div><div class="line">      * <span class="title">bd</span> - 展示的<span class="title">bitmap</span></div><div class="line">        <span class="title">position</span> - <span class="title">InfoWindow</span>显示的位置点</div><div class="line">        <span class="title">yOffset</span> - 信息窗口会与图层图标重叠，设置<span class="title">Y</span>轴偏移量可以解决</div><div class="line">        <span class="title">listener</span> - 点击监听者</div><div class="line">      */</div><div class="line">      <span class="title">mInfoWindow</span> = <span class="title">new</span> <span class="title">InfoWindow</span>(<span class="type">BitmapDescriptorFactory</span>.fromView(textView), <span class="title">latLng</span>, -47, <span class="title">listener</span>);</div><div class="line">      <span class="title">mBaiduMap</span>.<span class="title">showInfoWindow</span>(mInfoWindow);<span class="comment">//显示信息窗口</span></div><div class="line">    &#125; <span class="title">else</span> <span class="title">if</span> (marker.getZIndex() == <span class="title">mMarkerB</span>.<span class="title">getZIndex</span>()) &#123;<span class="comment">//如果是终点图层</span></div><div class="line">      <span class="title">Button</span> <span class="title">button</span> = <span class="title">new</span> <span class="title">Button</span>(getApplicationContext());</div><div class="line">      <span class="title">button</span>.<span class="title">setText</span>("终点");</div><div class="line">      <span class="title">button</span>.<span class="title">setOnClickListener</span>(new <span class="type">OnClickListener</span>() &#123;</div><div class="line">        <span class="title">public</span> <span class="title">void</span> <span class="title">onClick</span>(<span class="type">View</span> v) &#123;</div><div class="line">          <span class="title">Toast</span>.<span class="title">makeText</span>(getApplicationContext(),"这里是终点", <span class="title">Toast</span>.<span class="title">LENGTH_SHORT</span>).<span class="title">show</span>();</div><div class="line">          <span class="title">mBaiduMap</span>.<span class="title">hideInfoWindow</span>();</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line"></div><div class="line">      <span class="title">LatLng</span> <span class="title">latLng</span> = <span class="title">marker</span>.<span class="title">getPosition</span>();</div><div class="line">      /**</div><div class="line">      * 通过传入的 <span class="title">view</span> 构造一个 <span class="title">InfoWindow</span>, 此时只是利用该<span class="title">view</span>生成一个<span class="title">Bitmap</span>绘制在地图中，监听事件由自己实现。</div><div class="line">        <span class="title">view</span> - 展示的 <span class="title">view</span></div><div class="line">        <span class="title">position</span> - 显示的地理位置</div><div class="line">        <span class="title">yOffset</span> - <span class="title">Y</span>轴偏移量</div><div class="line">      */</div><div class="line">      <span class="title">mInfoWindow</span> = <span class="title">new</span> <span class="title">InfoWindow</span>(button, latLng, <span class="number">-47</span>);</div><div class="line">      <span class="title">mBaiduMap</span>.<span class="title">showInfoWindow</span>(mInfoWindow);</div><div class="line">    &#125; </div><div class="line">    <span class="title">return</span> <span class="title">true</span>;</div><div class="line"> &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//也可以给运动轨迹添加点击事件</span></div><div class="line"><span class="title">mBaiduMap</span>.<span class="title">setOnPolylineClickListener</span>(new <span class="type">BaiduMap</span>.<span class="type">OnPolylineClickListener</span>() &#123;</div><div class="line">  @<span class="title">Override</span></div><div class="line">  <span class="title">public</span> <span class="title">boolean</span> <span class="title">onPolylineClick</span>(<span class="type">Polyline</span> polyline) &#123;</div><div class="line">    <span class="title">if</span> (polyline.getZIndex() == <span class="title">mPolyline</span>.<span class="title">getZIndex</span>()) &#123;</div><div class="line">      <span class="title">Toast</span>.<span class="title">makeText</span>(getApplicationContext(),"点数：" + <span class="title">polyline</span>.<span class="title">getPoints</span>().<span class="title">size</span>() + ",<span class="title">width</span>:" + polyline.getWidth(), <span class="type">Toast</span>.<span class="type">LENGTH_SHORT</span>).show();</div><div class="line">    &#125;</div><div class="line">    return false;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>到这里，运动结束后画出整个轨迹图和图层添加点击事件就介绍完了。</p>
<h2 id="时时动态的画运动轨迹"><a href="#时时动态的画运动轨迹" class="headerlink" title="时时动态的画运动轨迹"></a>时时动态的画运动轨迹</h2><blockquote>
<p>关键在于取点：gps刚接收到信号时返回的一些点精度不高，容易造成位置偏移，如何取点很重要。</p>
</blockquote>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//伪代码</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">  mMapView = (MapView) findViewById(R.id.bmapView);</div><div class="line">  mBaiduMap = mMapView.getMap();</div><div class="line">  <span class="comment">// 开启定位图层</span></div><div class="line">  mBaiduMap.setMyLocationEnabled(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">  <span class="comment">/**添加地图缩放状态变化监听，当手动放大或缩小地图时，拿到缩放后的比例，然后获取到下次定位，</span></div><div class="line">  *  给地图重新设置缩放比例，否则地图会重新回到默认的mCurrentZoom缩放比例</div><div class="line">  */</div><div class="line">  mCurrentZoom = <span class="number">18</span>;</div><div class="line">  mBaiduMap.setOnMapStatusChangeListener(<span class="keyword">new</span> OnMapStatusChangeListener() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onMapStatusChangeStart</span><span class="params">(MapStatus arg0)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onMapStatusChangeFinish</span><span class="params">(MapStatus arg0)</span> </span>&#123;</div><div class="line">      mCurrentZoom = arg0.zoom;<span class="comment">//获取手指缩放地图后的值</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onMapStatusChange</span><span class="params">(MapStatus arg0)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="comment">//设置定位图标类型为跟随模式</span></div><div class="line">  mBaiduMap.setMyLocationConfiguration(<span class="keyword">new</span> MyLocationConfiguration(</div><div class="line">                com.baidu.mapapi.map.MyLocationConfiguration.LocationMode.FOLLOWING, <span class="keyword">true</span>, <span class="keyword">null</span>));</div><div class="line"></div><div class="line">  <span class="comment">// 定位初始化</span></div><div class="line">  mLocClient = <span class="keyword">new</span> LocationClient(<span class="keyword">this</span>);</div><div class="line">  mLocClient.registerLocationListener(myListener);</div><div class="line">  LocationClientOption option = <span class="keyword">new</span> LocationClientOption();</div><div class="line">  option.setLocationMode(LocationMode.Device_Sensors);<span class="comment">//只接受gps位置</span></div><div class="line">  option.setOpenGps(<span class="keyword">true</span>); <span class="comment">// 允许gps定位</span></div><div class="line">  option.setCoorType(<span class="string">"bd09ll"</span>); <span class="comment">// 设置坐标类型</span></div><div class="line">  option.setScanSpan(<span class="number">1000</span>);<span class="comment">//一秒一个gps</span></div><div class="line">  mLocClient.setLocOption(option);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//开始获取位置点</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">  start.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mLocClient != <span class="keyword">null</span> &amp;&amp; !mLocClient.isStarted()) &#123;</div><div class="line">            mLocClient.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//位置回调，取点很重要</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLocationListenner</span> <span class="keyword">implements</span> <span class="title">BDLocationListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onReceiveLocation</span><span class="params">(<span class="keyword">final</span> BDLocation location)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (location == <span class="keyword">null</span> || mMapView == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (location.getLocType() == BDLocation.TypeGpsLocation) &#123;<span class="comment">//只要gps点</span></div><div class="line"></div><div class="line">            <span class="keyword">if</span> (isFirstLoc) &#123;<span class="comment">//首次定位</span></div><div class="line">                <span class="comment">/**第一个点很重要，决定了轨迹的效果，gps刚接收到信号时返回的一些点精度不高，</span></div><div class="line">                * 尽量选一个精度相对较高的起始点，这个过程大概从gps刚接收到信号后5-10秒就可以完成，不影响效果。</div><div class="line">                * 注：gps接收卫星信号少则十几秒钟，多则几分钟，</div><div class="line">                * 如果长时间手机收不到gps，退出，重启手机再试，这是硬件的原因</div><div class="line">                */</div><div class="line">                LatLng ll = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">                <span class="comment">//选一个精度相对较高的起始点</span></div><div class="line">                ll = getMostAccuracyLocation(location);</div><div class="line">                <span class="keyword">if</span>(ll == <span class="keyword">null</span>)&#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                isFirstLoc = <span class="keyword">false</span>;</div><div class="line">                points.add(ll);<span class="comment">//加入集合</span></div><div class="line">                last = ll;</div><div class="line"></div><div class="line">                <span class="comment">//显示当前定位点，缩放地图</span></div><div class="line">                locateAndZoom(location, ll);</div><div class="line"></div><div class="line">                <span class="comment">//标记起点图层位置</span></div><div class="line">                MarkerOptions oStart = <span class="keyword">new</span> MarkerOptions();<span class="comment">// 地图标记覆盖物参数配置类</span></div><div class="line">                oStart.position(points.get(<span class="number">0</span>));<span class="comment">// 覆盖物位置点，第一个点为起点</span></div><div class="line">                oStart.icon(startBD);<span class="comment">// 设置覆盖物图片</span></div><div class="line">                mBaiduMap.addOverlay(oStart); <span class="comment">// 在地图上添加此图层</span></div><div class="line">                <span class="keyword">return</span>;<span class="comment">//画轨迹最少得2个点，首地定位到这里就可以返回了</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//从第二个点开始</span></div><div class="line">            LatLng ll = <span class="keyword">new</span> LatLng(location.getLatitude(), location.getLongitude());</div><div class="line">            <span class="comment">//sdk回调gps位置的频率是1秒1个，位置点太近动态画在图上不是很明显，可以设置点之间距离大于为5米才添加到集合中</span></div><div class="line">            <span class="keyword">if</span> (DistanceUtil.getDistance(last, ll) &lt; <span class="number">5</span>) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            points.add(ll);<span class="comment">//如果要运动完成后画整个轨迹，位置点都在这个集合中</span></div><div class="line"></div><div class="line">            last = ll;</div><div class="line"></div><div class="line">            <span class="comment">//显示当前定位点，缩放地图</span></div><div class="line">            locateAndZoom(location, ll);</div><div class="line"></div><div class="line">            <span class="comment">//清除上一次轨迹，避免重叠绘画</span></div><div class="line">            mMapView.getMap().clear();</div><div class="line"></div><div class="line">            <span class="comment">//起始点图层也会被清除，重新绘画</span></div><div class="line">            MarkerOptions oStart = <span class="keyword">new</span> MarkerOptions();</div><div class="line">            oStart.position(points.get(<span class="number">0</span>));</div><div class="line">            oStart.icon(startBD);</div><div class="line">            mBaiduMap.addOverlay(oStart);</div><div class="line"></div><div class="line">            <span class="comment">//将points集合中的点绘制轨迹线条图层，显示在地图上</span></div><div class="line">            OverlayOptions ooPolyline = <span class="keyword">new</span> PolylineOptions().width(<span class="number">13</span>).color(<span class="number">0xAAFF0000</span>).points(points);</div><div class="line">            mPolyline = (Polyline) mBaiduMap.addOverlay(ooPolyline);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//首次定位很重要，选一个精度相对较高的起始点</span></div><div class="line"><span class="keyword">private</span> <span class="function">LatLng <span class="title">getMostAccuracyLocation</span><span class="params">(<span class="keyword">final</span> BDLocation location)</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (location.getRadius()&gt;<span class="number">25</span>) &#123;<span class="comment">//gps位置精度大于25米的点直接弃用</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    LatLng ll = <span class="keyword">new</span> LatLng(location.getLatitude(), location.getLongitude());</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (DistanceUtil.getDistance(last, ll ) &gt; <span class="number">5</span>) &#123;</div><div class="line">        last = ll;</div><div class="line">        points.clear();<span class="comment">//有两点位置大于5，重新来过</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    points.add(ll);</div><div class="line">    last = ll;</div><div class="line">    <span class="comment">//有5个连续的点之间的距离小于5，认为gps已稳定，以最新的点为起始点</span></div><div class="line">    <span class="keyword">if</span>(points.size() &gt;= <span class="number">5</span>)&#123;</div><div class="line">        points.clear();</div><div class="line">        <span class="keyword">return</span> ll;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//显示当前定位点，缩放地图</span></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">locateAndZoom</span><span class="params">(BDLocation location, LatLng ll)</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * 记录当前经纬度，当位置不变，手机转动，取得方向传感器的方向，</div><div class="line">      给地图重新设置位置参数，在跟随模式下可使地图箭头随手机转动而转动</div><div class="line">    */</div><div class="line">    mCurrentLat = location.getLatitude();</div><div class="line">    mCurrentLon = location.getLongitude();</div><div class="line">    locData = <span class="keyword">new</span> MyLocationData.Builder().accuracy(<span class="number">0</span>)<span class="comment">//去掉精度圈</span></div><div class="line">            <span class="comment">//此mCurrentDirection为自己获取到的手机传感器方向信息，顺时针0-360</span></div><div class="line">            .direction(mCurrentDirection).latitude(location.getLatitude())</div><div class="line">            .longitude(location.getLongitude()).build();</div><div class="line">    mBaiduMap.setMyLocationData(locData);<span class="comment">//显示当前定位位置点</span></div><div class="line"></div><div class="line">    <span class="comment">//给地图设置缩放中心点，和缩放比例值</span></div><div class="line">    builder = <span class="keyword">new</span> MapStatus.Builder();</div><div class="line">    builder.<span class="keyword">target</span>(ll).zoom(mCurrentZoom);</div><div class="line">    mBaiduMap.animateMapStatus(MapStatusUpdateFactory.newMapStatus(builder.build()));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//运动结束增加终点图标</span></div><div class="line">finish.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mLocClient != <span class="keyword">null</span> &amp;&amp; mLocClient.isStarted()) &#123;</div><div class="line">            mLocClient.stop();<span class="comment">//停止定位</span></div><div class="line"></div><div class="line">            <span class="keyword">if</span>(points.size() &lt;= <span class="number">0</span>)&#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//运动结束记得标记终点图标</span></div><div class="line">            MarkerOptions oFinish = <span class="keyword">new</span> MarkerOptions();</div><div class="line">            oFinish.position(points.get(points.size() - <span class="number">1</span>));</div><div class="line">            oFinish.icon(finishBD);</div><div class="line">            mBaiduMap.addOverlay(oFinish); </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>退出记得释放资源<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">//伪代码</div><div class="line">protected void onDestroy() &#123;</div><div class="line">  // 退出时销毁定位</div><div class="line">  mLocClient.unRegisterLocationListener(myListener)<span class="comment">;</span></div><div class="line">  mLocClient.stop()<span class="comment">;</span></div><div class="line">  // 关闭定位图层</div><div class="line">  mBaiduMap.setMyLocationEnabled(false)<span class="comment">;</span></div><div class="line">  mMapView.getMap().clear()<span class="comment">;</span></div><div class="line">  mMapView.onDestroy()<span class="comment">;</span></div><div class="line">  mMapView = null<span class="comment">;</span></div><div class="line">  startBD.recycle()<span class="comment">;</span></div><div class="line">  finishBD.recycle()<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>我们画运动轨迹要求定位sdk返回的位置精度很高，轨迹的效果才会好，因而必须接受gps位置点。但是gps位置的在刚开始收到信号时精度不高，会出现位置漂移的情况，所以要选取一个精度较好的点。在建筑物、桥梁、大树、隧道里面，gps信号不好，精度不高，所以在开阔地带，运动轨迹效果更好。</p>
</blockquote>
<!-- <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=100% height=86 src="//music.163.com/outchain/player?type=2&id=songid&auto=1&height=66"></iframe> --></div>
    
      <p class="post-copyright">转载文章请链接上原文地址：<a class="post-copyright-link" href="http://dinson.win/2017/07/10/17-07-03/" title="http://dinson.win/2017/07/10/17-07-03/" target="_blank">http://dinson.win/2017/07/10/17-07-03/</a></p>

      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#静态画整个运动轨迹"><span class="toc-text">静态画整个运动轨迹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#画轨迹"><span class="toc-text">画轨迹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加起始图标图层、点击图层响应事件"><span class="toc-text">添加起始图标图层、点击图层响应事件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#时时动态的画运动轨迹"><span class="toc-text">时时动态的画运动轨迹</span></a></li></ol>
          </div>
        </div>
      </div>
    
  
  
 
</article>

      <footer class="footer">
  <p class="footer-text">© 2016 - 2017 ❤ Powered by - DINSON</p>
   
  <span id="busuanzi_container_site_pv"><i class="iconfont icon-dianji"></i>&nbsp;&nbsp;<span id="busuanzi_value_site_pv"></span>Times</span>
  <span style="margin: 0.5em 0.5em">|</span>
  <span id="busuanzi_container_site_uv"><i class="iconfont icon-fangke"></i>&nbsp;&nbsp;<span id="busuanzi_value_site_uv"></span>Times</span>
  <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <p class="footer-text">一只穿着空气鞋碎花沙滩裤挂着大金链子叼着烟戴着墨镜翘着二郎腿边弹吉他边敲代码的程序猿</p>

  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</footer> 
    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
