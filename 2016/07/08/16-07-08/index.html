<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <meta name="keywords" content="Android,设计模式,安卓入门,安卓高级,前端,JavaScript,h5,css3,Jquery">
  <meta name="description" content="null">
  <meta name="author" content="DINSON">
 
 
<meta name="keywords" content="Android,设计模式,安卓入门,安卓高级,前端,JavaScript,h5,css3,Jquery">


  
  <title>Android换肤技术总结</title>
  

  <link rel="alternate" href="/atom.xml" title="Android - Dinson - 酸奶布丁 - 国家一级码农" type="application/atom+xml">
  <link rel="canonical" href="http://dinson.win/2016/07/08/16-07-08/index.html">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_6u0jghgd9pco9a4i.css">
</head>


  <body>
    <aside class="aside">
  <nav class="aside-menu">
    <ul class="aside-list">
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-home"></i><a href="/index.html" class="aside-menu-link" title="酸奶布丁">酸奶布丁</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-all"></i><a href="/archives/index.html" class="aside-menu-link" title="时间印记">时间印记</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-tag"></i><a href="/tags/index.html" class="aside-menu-link" title="分类标记">分类标记</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-me"></i><a href="/about/index.html" class="aside-menu-link" title="关于">关于</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-rss"></i><a href="/atom.xml" class="aside-menu-link" title="RSS">RSS</a></li>
        
      
        
        <li class="aside-item"><i class="aside-menu-icon iconfont icon-pikaqiu"></i><a href="http://dinson.win/Pokemon/" class="aside-menu-link" title="口袋妖怪">口袋妖怪</a></li>
        
      
    </ul>
  </nav>

  <article class="aside-show">
    
      <form class="search-from" id="search-from">
  <input class="search-text" id="search-text" type="text" name="searchText" value="" autocomplete="off">
  <button class="search-btn" id="search-btn" type="button"><i class="search-btn-icon iconfont icon-sousuo-sousuo"></i></button>
</form>

      <article class="search-data" id="search-data">
  <button class="search-close" id="search-close"><i class="search-close-icon iconfont icon-quxiao"></i></button>

  <div class="search-wrapper" id="search-wrapper"></div>
</article>

    
    <div class="aside-show-wrapper">
      <figure class="aside-avatar">
        <img src="/img/avatar.jpg" alt="avatar" class="aside-avatar-img">
        <figcaption class="aside-avatar-caption">
          Dinson
          
          <strong class="aside-avatar-STRONG">Android喵</strong>
          
        </figcaption>
      </figure>
      <p class="aside-show-description">面朝电脑--栀子花开</p>
      <ul class="aside-show-info" >
	  <li class="aside-show-item"><a href="https://github.com/DinsonCat" class="aside-show-link" target="_blank"><i class="aside-show-icon iconfont icon-github"></i></a></li>
        <li class="aside-show-item">
          <a href="javascript: void(0);" class="aside-show-link"   target="_blank"><i class="aside-show-icon iconfont icon-wechat"></i></a>
          <div class="aside-show-outside aside-show-outside_1">
            <img class="aside-show-IMG aside-show-IMG_1" src="/img/weixin.png" alt="微信"  >
          </div>
        </li>
        <li class="aside-show-item">
          <a href="javascript: void(0);" class="aside-show-link"   target="_blank"><i class="aside-show-icon iconfont icon-qq"></i></a>
          <div class="aside-show-outside">
            <img class="aside-show-IMG  " src="/img/qq.jpg"   alt="QQ">
          </div>
        </li>
		 
      </ul>
	
	 
    </div>
	
  </article>
</aside>


    <article class="main" id="main">
      <article class="post min-height">
  
  <header class="post-header">
    
    <h1 class="post-title">Android换肤技术总结</h1>
    <p class="post-meta">
      <span class="post-time">2016-07-08</span>
      
      <a href="/categories/Android嫡系/" class="post-categories">Android嫡系</a>
      
      
      <a href="/tags/主题换肤/"" class="post-tags"><i class="post-tags-icon iconfont icon-waixingren"></i>主题换肤</a>
      
	  
	  
		<span id="busuanzi_container_page_pv"  class="post-time"><i class="post-tags-icon iconfont icon-yuedu"></i>Views <span id="busuanzi_value_page_pv"></span> Times</span>
	  
	  
    </p>
    
  </header>
  <div class="post-content"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><blockquote>
<p>纵观现在各种Android app，其换肤需求可以归为<br></p>
<ul>
<li>白天/黑夜主题切换（或者别的名字，通常2套），如同花顺/自选股/天天动听等，UI表现为一个switcher。</li>
<li>多种主题切换，通常为会员特权，如QQ/QQ空间。</li>
</ul>
<p>对于第一种来说，目测应该是直接通过本地theme来做的，即所有图片/颜色的资源都在apk里面打包了。</p>
<p>而对于第二种，则相对复杂一些，由于作为一种线上服务，可能上架新皮肤，且那么多皮肤包放在apk里面实在太占体积了，所以皮肤资源会在选择后再进行下载，也就不能直接使用android的那套theme。</p>
</blockquote>
<a id="more"></a>
<h2 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a>技术方案</h2><p>内部资源加载方案和动态下载资源下载两种。</p>
<p>动态下载可以称为一种黑科技了，因为往往需要hack系统的一些方法，所以在部分机型和新的API上有时候可能有坑，但相对好处则很多</p>
<ul>
<li>图片/色值等资源由于是后台下发的，可以随时更新</li>
<li>APK体积减小</li>
<li>对应用开发者来说，换肤几乎是透明的，不需要关心有几套皮肤</li>
<li><strong>可以作为增值服务卖钱！！</strong></li>
</ul>
<h2 id="内部资源加载方案"><a href="#内部资源加载方案" class="headerlink" title="内部资源加载方案"></a>内部资源加载方案</h2><p>内部资源加载都是通过android本身那套theme来做的，相对业务开发来说工作量更大（需要定义attr和theme），不同方案类似地都是在BaseActivity里面做setTheme，差别主要在解决以下2个问题的策略：</p>
<ul>
<li>setTheme后如何实时刷新，而不用重新创建页面（尤其是listview里面的item）。</li>
<li>哪些view需要刷新，刷新什么（背景？字体颜色？ImageView的src？）。</li>
</ul>
<h2 id="自定义view"><a href="#自定义view" class="headerlink" title="自定义view"></a>自定义view</h2><p><a href="https://github.com/dersoncheng/MultipleTheme" target="_blank" rel="external">MultipleTheme</a><br>做自定义view是为了在setTheme后会去立即刷新，更新页面UI对应资源（如TextView替换背景图和文字颜色），在上述项目中，则是通过对rootView进行遍历，对所有实现了ColorUiInterface的view/viewgroup进行setTheme操作来实现即使刷新的。</p>
<p>显然这样太重了，需要把应用内的各种view/viewgroup进行替换。</p>
<h2 id="手动绑定view和要改变的资源类型"><a href="#手动绑定view和要改变的资源类型" class="headerlink" title="手动绑定view和要改变的资源类型"></a>手动绑定view和要改变的资源类型</h2><p><a href="https://github.com/hehonghui/Colorful" target="_blank" rel="external">Colorful</a></p>
<p>这个…我们看看用法吧….<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="type">ViewGroupSetter</span> listViewSetter = <span class="function"><span class="keyword">new</span> <span class="title">ViewGroupSetter</span>(mNewsListView);</span></div><div class="line"><span class="comment">// 绑定ListView的Item View中的news_title视图，在换肤时修改它的text_color属性</span></div><div class="line"><span class="title">listViewSetter</span>.<span class="title">childViewTextColor</span>(<span class="type">R</span>.id.news_title, <span class="type">R</span>.attr.text_color);</div><div class="line"></div><div class="line"><span class="comment">// 构建Colorful对象来绑定View与属性的对象关系</span></div><div class="line"><span class="title">mColorful</span> = <span class="title">new</span> <span class="title">Colorful</span>.<span class="title">Builder</span>(this)</div><div class="line">        .<span class="title">backgroundDrawable</span>(<span class="type">R</span>.id.root_view, <span class="type">R</span>.attr.root_view_bg)</div><div class="line">        <span class="comment">// 设置view的背景图片</span></div><div class="line">        .<span class="title">backgroundColor</span>(<span class="type">R</span>.id.change_btn, <span class="type">R</span>.attr.btn_bg)</div><div class="line">        <span class="comment">// 设置背景色</span></div><div class="line">        .<span class="title">textColor</span>(<span class="type">R</span>.id.textview, <span class="type">R</span>.attr.text_color)</div><div class="line">        .<span class="title">setter</span>(listViewSetter) <span class="comment">// 手动设置setter</span></div><div class="line">        .<span class="title">create</span>(); <span class="comment">// 设置文本颜色</span></div></pre></td></tr></table></figure></p>
<p>我就是想换个皮肤，还得在activity里自己去设置要改变哪个view的什么属性，对应哪个attribute？是不是成本太高了？而且activity的逻辑也很容易被弄得乱七八糟。</p>
<h2 id="动态资源加载方案"><a href="#动态资源加载方案" class="headerlink" title="动态资源加载方案"></a>动态资源加载方案</h2><ul>
<li><p>resource替换</p>
<p>  覆盖application的getResource方法，实现自己的resource，优先加载本地皮肤包文件夹下的资源包，对于性能问题，可以通过attribute或者资源名称规范(如需要换肤则用skin_开头)来优化，从而不对不换肤的资源进行额外检查开销。</p>
<p>  不过由于Android5.1源码里，drawable初始化的时候调用的是loadDrawable，而不是resource.getDrawable，而loadDrawable是私有的方法，无法覆盖，所以虽然很方便，却无法继续使用（不用关心任何皮肤相关的事情，android:color指定颜色就行了，神奇滴会自动换肤）。</p>
</li>
<li><p>自定义LayoutInflator.Factory</p>
<p>  开源项目可参照<a href="https://github.com/fengjundev/Android-Skin-Loader" target="_blank" rel="external">Android-Skin-Loader</a>。</p>
<p>  即setFactory使用自定义的LayoutInflator.Factory，可以重点关注该项目中的SkinInflaterFactory和SkinManager（实现了自己的getColor、getDrawable、getBitmap、getColorStateList等等方法）。</p>
<p>  需要自定义一个tag比如app:customStyle，重写所有的style，转成set方法，这样带来的牺牲就是增加了换肤的成本，要写很多style，自己去set，并不完全透明了。</p>
</li>
<li><p>Hack Resources internally</p>
</li>
</ul>
<p>黑科技方法，直接对Resources进行hack，Resources.java:<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Information about preloaded resources.  Note that they are not</span></div><div class="line"><span class="comment">// protected by a lock, because while preloading in zygote we are all</span></div><div class="line"><span class="comment">// single-threaded, and after that these are immutable.</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LongSparseArray&lt;Drawable.ConstantState&gt;[] sPreloadedDrawables;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LongSparseArray&lt;Drawable.ConstantState&gt; sPreloadedColorDrawables</div><div class="line">        = <span class="keyword">new</span> LongSparseArray&lt;Drawable.ConstantState&gt;();</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LongSparseArray&lt;ColorStateList&gt; sPreloadedColorStateLists</div><div class="line">        = <span class="keyword">new</span> LongSparseArray&lt;ColorStateList&gt;();</div></pre></td></tr></table></figure></p>
<p>直接对Resources里面的这三个LongSparseArray进行替换，由于apk运行时的资源都是从这三个数组里面加载的，所以只要采用interceptor模式：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DrawablePreloadInterceptor</span> <span class="keyword">extends</span> <span class="title">LongSparseArray&lt;Drawable</span>.<span class="title">ConstantState&gt;</span></span></div></pre></td></tr></table></figure>
<p>自己实现一个LongSparseArray，并通过反射set回去，就能实现换肤，具体getDrawable等方法里是怎么取preload数组的，可以自己看Resources的源码。</p>
<p><strong>等等，就这么简单？</strong>，NONO，少年你太天真了，怎么去加载xml，9patch的padding怎么更新，怎么打包/加载自定义的皮肤包，drawable的状态怎么刷新，等等。这些都是你需要考虑的，在存在插件的app中，还需要考虑是否会互相覆盖resource id的问题，进而需要修改apt，把resource id按位放在2个range。</p>
<p>手机Q和独立版QQ空间使用的是这种方案，效果挺好。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>尽管动态加载方案比较黑科技，可能因为系统API的更改而出问题</p>
<h4 id="好处有"><a href="#好处有" class="headerlink" title="好处有"></a>好处有</h4><ul>
<li>灵活性高，后台可以随时更新皮肤包</li>
<li>相对透明，开发者几乎不用关心有几套皮肤，不用去定义各种theme和attr，甚至连皮肤包的打包都可以交给设计或者专门的同学</li>
<li>apk体积节省</li>
</ul>
<h4 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h4><ul>
<li>没有完善的开源项目，如果我们采用动态加载的第二种方案，需要的项目功能包括：</li>
<li>自定义皮肤包结构</li>
<li>换肤引擎，加载皮肤包资源并load，实时刷新。</li>
<li>皮肤包打包工具</li>
<li>对各种rom的兼容</li>
</ul>
<p>内部加载方案大同小异，主要解决的都是即时刷新的问题，然而从目前的一些开源项目来看，仍然没有特别简便的方案。让我选的话，我宁愿让界面重新创建，比如重启activity，或者remove所有view再添加回来（或者你可能想遍历rootview，然后一个个检查是否需要换肤然后set…）。</p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="100%" height="86" src="//music.163.com/outchain/player?type=2&id=65525&auto=1&height=66"></iframe></div>
    
      <p class="post-copyright">转载文章请链接上原文地址：<a class="post-copyright-link" href="http://dinson.win/2016/07/08/16-07-08/" title="http://dinson.win/2016/07/08/16-07-08/" target="_blank">http://dinson.win/2016/07/08/16-07-08/</a></p>

      
      <div class="toc-wrapper">
        <div class="toc-scroll">
          <div class="toc-middle">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#技术方案"><span class="toc-text">技术方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内部资源加载方案"><span class="toc-text">内部资源加载方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义view"><span class="toc-text">自定义view</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#手动绑定view和要改变的资源类型"><span class="toc-text">手动绑定view和要改变的资源类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态资源加载方案"><span class="toc-text">动态资源加载方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#好处有"><span class="toc-text">好处有</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#存在的问题"><span class="toc-text">存在的问题</span></a></li></ol></li></ol></li></ol>
          </div>
        </div>
      </div>
    
  
  
 
</article>

      <footer class="footer">
  <p class="footer-text">© 2016 - 2017 ❤ Powered by - DINSON</p>
   
  <span id="busuanzi_container_site_pv"><i class="iconfont icon-dianji"></i>&nbsp;&nbsp;<span id="busuanzi_value_site_pv"></span>Times</span>
  <span style="margin: 0.5em 0.5em">|</span>
  <span id="busuanzi_container_site_uv"><i class="iconfont icon-fangke"></i>&nbsp;&nbsp;<span id="busuanzi_value_site_uv"></span>Times</span>
  <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <p class="footer-text">一只穿着空气鞋碎花沙滩裤挂着大金链子叼着烟戴着墨镜翘着二郎腿边弹吉他边敲代码的程序猿</p>

  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</footer> 
    </article>

    <script src="/js/to-top.js"></script>
    <script src="/js/search.js"></script>
  </body>
</html>
